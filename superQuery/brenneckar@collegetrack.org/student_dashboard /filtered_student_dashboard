WITH gather_student_data AS (
  SELECT
    Contact_Id,
    site_short,
    College_Track_Status_Name,
    high_school_graduating_class_c,
    grade_c,
    full_name_c,
    email,
    Most_Recent_GPA_Cumulative_c,
    most_recent_gpa_semester_c,
    total_bank_book_balance_contact_c,
    community_service_hours_c,
    Attendance_Rate_Current_AS_c,
    Current_HS_CT_Coach_c,
    community_service_form_link_c,
    summer_experience_form_link_c,
    current_academic_semester_c,
    previous_academic_semester_c
  FROM
    `data-warehouse-289815.salesforce_clean.contact_at_template`

  WHERE
    college_track_status_c IN ('11A', '18a', '12A')
    AND current_as_c = true
),
gather_workshop_data AS (
  SELECT
    student_c,
    workshop_display_name_c,
    start_time_c,
    recurring_days_c,
    class_status,
    Academic_Semester_c,
    SUM(Attendance_Numerator_c) AS attended_sessions,
    SUM(Attendance_Denominator_c) AS enrolled_sessions,
    CASE WHEN SUM(Attendance_Denominator_c) = 0 THEN NULL 
    ELSE SUM(Attendance_Numerator_c) / SUM(Attendance_Denominator_c) END AS attendance_rate
  FROM
    `data-warehouse-289815.salesforce_clean.class_template`
  GROUP BY
    student_c,
    workshop_display_name_c,
    start_time_c,
    recurring_days_c,
    class_status,
    Academic_Semester_c
)
SELECT
  GSD.*,
  GWD.* EXCEPT (student_c, academic_semester_c)
FROM
  gather_student_data GSD
  LEFT JOIN gather_workshop_data GWD ON GSD.Contact_Id = GWD.Student_c
  AND GSD.previous_academic_semester_c = GWD.Academic_Semester_c
  
  
  
  
  