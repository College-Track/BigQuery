WITH filtered_data AS #compile college application, contact data, academic term data for GPA
(
SELECT
    
#college application data    
    CA.name,
    CA.College_University_c AS app_college_id,
    CA.admission_status_c,
    CASE
        WHEN admission_status_c IS NULL THEN "Admission Status Not Updated"
        ELSE admission_status_c
    END AS admission_status,
    CASE 
        WHEN admission_status_c = "Accepted" OR admission_status_c = "Accepted and Enrolled" OR admission_status_c = "Accepted and Deferred" 
        THEN 1
        ELSE 0
    END AS accepted,
    CA.application_status_c,
    CASE  
        WHEN CA.application_status_c IS NULL THEN "No College Application"
        ELSE CA.application_status_c
    END AS application_status,
    CASE
        WHEN CA.College_Fit_Type_Applied_c = "Best Fit" THEN 1
        WHEN CA.College_Fit_Type_Applied_c = "Good Fit" THEN 2
        WHEN CA.College_Fit_Type_Applied_c = "Local Affordable" THEN 3
        WHEN CA.College_Fit_Type_Applied_c = "None" THEN 4
        ELSE 0
    END AS sort_helper_app_by_fit_type,
    
    CA.Average_Financial_Aid_Package_c,
    CA.Avg_Debt_of_Graduates_c,
    CA.Award_Letter_c,
    CA.CSS_Profile_Required_c,
    CA.CSS_Profile_c,
    CASE
        WHEN CA.CSS_Profile_c IS NULL THEN 'Missing Status'
        ELSE CA.CSS_Profile_c
    END AS CSS_profile_status,
    CA.College_Fit_Type_Applied_c,
    CA.College_University_Academic_Calendar_c,
    CA.Control_of_Institution_c, #private or public school,
    CA.Enrollment_Deposit_c,
    CA.School_s_Financial_Aid_Form_Required_c, #yes/no
    CA.School_Financial_Aid_Form_Status_c,
    CASE 
        WHEN CA.School_Financial_Aid_Form_Status_c IS NULL THEN 'Missing Status'
        ELSE CA.School_Financial_Aid_Form_Status_c
    END AS School_Financial_Aid_Form_Status,
    CA.Fit_Type_Current_c,
    CA.Fit_Type_Enrolled_c,
    CASE
        WHEN CA.fit_type_enrolled_c = "Best Fit" THEN 1
        WHEN CA.fit_type_enrolled_c = "Situational" THEN 2
        WHEN CA.fit_type_enrolled_c = "Good Fit" THEN 3
        WHEN CA.fit_type_enrolled_c = "Local Affordable" THEN 4
        WHEN CA.fit_type_enrolled_c = "None" THEN 5
        ELSE 0
    END AS sort_helper_enroll_by_fit_type,
    CA.Housing_Application_c,
    CA.id as college_app_id,
    CA.Predominant_Degree_Awarded_c,
    CA.Type_of_School_c,
    CA.Situational_Fit_Type_c,
    CA.Strategic_Type_c AS match_type, #match type
    CA.Verification_Status_c,
    CA.Student_c,

#Contact 
    C.full_name_c,
    C.contact_id,
    ((COUNT(DISTINCT CA.student_c))/(COUNT(DISTINCT C.contact_id))) AS percent_of_students, #percent of seniors with college application
    C.high_school_graduating_class_c,
    C.College_Track_Status_Name,
    C.grade_c, 
    C.Gender_c ,
    C.Ethnic_background_c ,
    C.indicator_low_income_c,
    C.first_generation_fy_20_c, 
    C.site_short,
    CASE
        WHEN C.site_short = "East Palo Alto" THEN 1
        WHEN C.site_short = "Oakland" THEN 2
        WHEN C.site_short = "San Francisco" THEN 3
        WHEN C.site_short = "Sacramento" THEN 4
        WHEN C.site_short = "New Orleans" THEN 5
        WHEN C.site_short = "Aurora" THEN 6
        WHEN C.site_short = "Denver" THEN 7
        WHEN C.site_short = "Boyle Heights" THEN 8
        WHEN C.site_short = "Watts" THEN 9
        ELSE 0
    END AS sort_helper_site,    
    C.region_short,
    C.readiness_english_official_c,
    C.readiness_composite_off_c,
    C.readiness_math_official_c,
    C.fa_req_expected_financial_contribution_c, 
    CASE 
        WHEN C.fa_req_expected_financial_contribution_c IS NULL THEN 'Missing EFC'
        ELSE 'Reported EFC' 
    END AS EFC_indicator,
    CASE 
        WHEN C.fa_req_expected_financial_contribution_c = 0 THEN 'Full Pell'
        WHEN C.fa_req_expected_financial_contribution_c >= 1 AND C.fa_req_expected_financial_contribution_c < 5711 THEN 'Partial Pell'
        WHEN C.fa_req_expected_financial_contribution_c >= 5711 THEN 'Pell Ineligible'
        WHEN C.fa_req_expected_financial_contribution_c IS NULL THEN 'Missing EFC'
    END AS Pell_indicator,
    C.fa_req_fafsa_c,
    CASE 
        WHEN C.fa_req_fafsa_c IS NULL THEN 'Missing Status' 
        ELSE C.fa_req_fafsa_c 
    END AS FAFSA_status,
    
#College Aspiration data
    CAP.Id AS aspiration_id,
    CAP.Aspiration_Category_c,
    CASE 
        WHEN CAP.Id IS NULL THEN "No College Aspiration"
        WHEN CAP.Aspiration_Category_c IS NULL THEN "Category Not Selected"
        ELSE CAP.Aspiration_Category_c
    END AS aspiration_category,
    CAP. College_University_c AS aspiration_college_id,
    
#Academic Term data 
    A_T.gpa_semester_cumulative_c AS CGPA_11th,
    A_T.Name AS Name_AT, #academic term name
    A_T.AT_Grade_c, #grade on AT
    A_T.AT_Record_Type_Name,
    A_T.ct_coach_c,
    
#Account object mapping
    ACCNT_APP.Name AS app_college_name, 
    ACCNT_ASP.Name AS aspiration_college_name
    
        
FROM `data-warehouse-289815.salesforce_clean.contact_template` AS C    
LEFT JOIN `data-warehouse-289815.salesforce_clean.college_application_clean` AS CA 
        ON C.contact_id = CA.student_c
LEFT JOIN `data-warehouse-289815.salesforce.account` AS accnt_app #pull in college name in application 
        ON CA.college_university_c = accnt_app.id
LEFT JOIN `data-warehouse-289815.salesforce.college_aspiration_c` AS CAP
        ON C.contact_id = CAP.student_c
LEFT JOIN `data-warehouse-289815.salesforce.account` AS accnt_asp #pull in college name in aspiration
        ON CAP.college_university_c = accnt_asp.id        
LEFT JOIN `data-warehouse-289815.salesforce_clean.contact_at_template` AS A_T
        ON C.contact_Id = A_T.contact_Id 
        
WHERE C.grade_c = '12th Grade'
    AND C.College_Track_Status_Name = 'Current CT HS Student'
    AND AT_Record_Type_Name = 'High School Semester'
    AND A_T.indicator_years_since_hs_grad_to_date_c = -1.34 #11th Grade Spring Term

GROUP BY 
    CA.name,
    app_college_id,
    CA.admission_status_c,
    admission_status,
    accepted,
    CA.application_status_c,
    application_status,
    sort_helper_app_by_fit_type,
    CA.Average_Financial_Aid_Package_c,
    CA.Avg_Debt_of_Graduates_c,
    CA.Award_Letter_c,
    CA.CSS_Profile_Required_c,
    CA.CSS_Profile_c,
    CSS_profile_status,
    CA.College_Fit_Type_Applied_c,
    CA.College_University_Academic_Calendar_c,
    CA.Control_of_Institution_c, #private or public school,
    CA.Enrollment_Deposit_c,
    CA.School_s_Financial_Aid_Form_Required_c, #yes/no
    CA.School_Financial_Aid_Form_Status_c,
    School_Financial_Aid_Form_Status,
    CA.Fit_Type_Current_c,
    CA.Fit_Type_Enrolled_c,
    sort_helper_enroll_by_fit_type,
    CA.Housing_Application_c,
    college_app_id,
    CA.Predominant_Degree_Awarded_c,
    CA.Type_of_School_c,
    CA.Situational_Fit_Type_c,
    match_type, #match type
    CA.Verification_Status_c,
    CA.Student_c,
    C.full_name_c,
    C.contact_id,
    C.high_school_graduating_class_c,
    C.College_Track_Status_Name,
    C.grade_c, 
    C.Gender_c ,
    C.Ethnic_background_c ,
    C.indicator_low_income_c,
    C.first_generation_fy_20_c, 
    C.site_short,
    sort_helper_site,    
    C.region_short,
    C.readiness_english_official_c,
    C.readiness_composite_off_c,
    C.readiness_math_official_c,
    C.fa_req_expected_financial_contribution_c, 
    EFC_indicator,
    Pell_indicator,
    C.fa_req_fafsa_c,
    FAFSA_status,
    
#College Aspiration data
    aspiration_id,
    CAP.Aspiration_Category_c,
    aspiration_category,
    aspiration_college_id,
    
#Academic Term data 
    CGPA_11th,
    Name_AT, #academic term name
    A_T.AT_Grade_c, #grade on AT
    A_T.AT_Record_Type_Name,
    A_T.ct_coach_c,
    
#Account object mapping
    app_college_name, 
    aspiration_college_name
)

SELECT *
    EXCEPT (application_status_c, Aspiration_Category_c, admission_status_c),
    
    CASE
        WHEN Aspiration_Category = "Guaranteed" THEN 1
        WHEN Aspiration_Category = "Match" THEN 2
        WHEN Aspiration_Category = "Likely" THEN 3
        WHEN Aspiration_Category = "Reach" THEN 4
        WHEN Aspiration_Category = "Category Not Selected" THEN 5
        WHEN Aspiration_Category = "No College Aspiration" THEN 6
        ELSE 0
    END AS sort_helper_aspiration_category,
    
    CASE
        WHEN application_status = "Prospect" THEN 1
        WHEN application_status = "In Progress" THEN 2
        WHEN application_status = "Applied" THEN 2
        WHEN application_status = "Accepted" THEN 3
        WHEN application_status = "No College Application" THEN 4
        ELSE 0
    END AS sort_helper_app_status,    
    
    CASE
        WHEN admission_status = "Accepted" THEN 1
        WHEN admission_status = "Accepted and Enrolled" THEN 2
        WHEN admission_status = "Accepted and Deferred" THEN 3
        WHEN admission_status = "Wait-listed" THEN 4
        WHEN admission_status = "Conditional" THEN 5
        WHEN admission_status = "Withdrew Application" THEN 6
        WHEN admission_status = "Undecided" THEN 7
        WHEN admission_status = "Denied" THEN 8
        WHEN admission_status = "Admission Status Not Updated" THEN 9
        ELSE 0
    END AS sort_helper_admission_status
    
FROM filtered_data