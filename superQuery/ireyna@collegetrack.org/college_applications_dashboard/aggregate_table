WITH aggregate_data AS #contact demo data
(
SELECT
    site_short,
    region_short,
    Gender_c,
    first_generation_fy_20_c,
    indicator_low_income_c,
    Ethnic_background_c,
    COUNT(contact_id) AS student_count,
    
FROM `data-studio-260217.college_applications.college_application_filtered_table`
GROUP BY
    site_short,
    region_short,
    Gender_c,
    first_generation_fy_20_c,
    indicator_low_income_c,
    Ethnic_background_c
),

college_application_counts AS
(
SELECT
    site_short,
    college_app_id,
    accepted,
    COUNT(DISTINCT college_app_id) AS college_app_count

FROM `data-studio-260217.college_applications.college_application_filtered_table` 

GROUP BY
    site_short,
    accepted,
    college_app_id
),

acceptance_counts AS
(
SELECT 
    college_app_id,
    accepted,
    site_short
    
FROM `data-studio-260217.college_applications.college_application_filtered_table` 
WHERE 
    application_status = "Applied"
    AND accepted = 1
    
GROUP BY 
    site_short,
    college_app_id, 
    accepted
),

aggregate_app_accepted AS
(
SELECT 
    SUM(acceptance.accepted) AS accepted_sum,
    application.site_short,
    college_app_count
    
FROM college_application_counts AS application
LEFT JOIN acceptance_counts AS acceptance
    ON application.college_app_id = acceptance.college_app_id
    
GROUP BY 
    application.site_short,
    college_app_count,
    acceptance.accepted
),

college_aspiration_counts AS 
(
SELECT
    site_short,
    COUNT(aspiration_id) AS college_aspiration_count
FROM `data-studio-260217.college_applications.college_application_filtered_table`

GROUP BY site_short
)

SELECT 
    A.*,
    college_app_count,
    college_aspiration_count,
   SUM(accepted_sum) AS accepted_agg
    

FROM aggregate_data AS A
LEFT JOIN aggregate_app_accepted AS agg    
    ON A.site_short = agg.site_short
LEFT JOIN college_aspiration_counts AS CAP
    ON A.site_short = CAP.site_short

GROUP BY
    site_short,
    region_short,
    student_count,
    college_app_count,
    college_aspiration_count,
    Gender_c,
    first_generation_fy_20_c,
    indicator_low_income_c,
    Ethnic_background_c