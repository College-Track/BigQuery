CREATE OR REPLACE TABLE `data-studio-260217.college_applications.aggregate_college_applications`
OPTIONS
    (
    description= "Aggregate College Application, College Aspiration data, and Contact demo data"
    )
AS

WITH agg_table AS #contact demo demo
(
SELECT
    site_short,
    region_short,
    Gender_c,
    first_generation_fy_20_c,
    indicator_low_income_c,
    Ethnic_background_c,
    contact_id
    
FROM `data-studio-260217.college_applications.college_application_filtered_table`    
),

app_aspiration_count AS #college app and aspiration aggregate counts
(
SELECT
    contact_id,
    COUNT(DISTINCT contact_id) AS student_count,
    COUNT(DISTINCT college_app_id) AS app_count,
    COUNT(DISTINCT CAP.id) AS college_aspiration_count
    
FROM `data-studio-260217.college_applications.college_application_filtered_table` AS student_count

LEFT JOIN `data-warehouse-289815.salesforce.college_aspiration_c` AS CAP
        ON student_count.contact_id = CAP.student_c
        
GROUP BY
    contact_id
  
),

applied_counts AS #sum of status of "applied" across distinct college app ids 
(
SELECT
    site_short,
    region_short,
    contact_id,
    COUNT(DISTINCT college_app_id) AS applied_sum, 
    
FROM
    (SELECT *
    FROM `data-studio-260217.college_applications.college_application_filtered_table` 
    WHERE application_status = 'Applied')
AS applied_group

GROUP BY
    site_short,
    region_short,
    contact_id
),

acceptance_counts AS #sum of acceptances across distinct college app ids 
(
SELECT
    site_short,
    region_short,
    contact_id,
    COUNT(DISTINCT college_app_id) AS accepted_app_sum,
    COUNT(DISTINCT contact_id) AS accepted_student_sum
    
FROM
    (SELECT *
    FROM `data-studio-260217.college_applications.college_application_filtered_table` 
    WHERE accepted =1)
AS accepted_group

GROUP BY
    site_short,
    region_short,
    contact_id
)

SELECT 
    A.site_short,
    A.region_short,
    A.Gender_c,
    A.first_generation_fy_20_c,
    A.indicator_low_income_c,
    A.Ethnic_background_c,
    student_count,
    college_aspiration_count,
    app_count,
    accepted_app_sum,
    accepted_student_sum,
    applied_sum
    
FROM agg_table AS A
LEFT JOIN acceptance_counts AS AC
    ON A.contact_id = AC.contact_id
LEFT JOIN applied_counts AS APC
    ON A.contact_id = APC.contact_id
LEFT JOIN app_aspiration_count AS AAC
    ON A.contact_id = AAC.contact_id

GROUP BY
    A.contact_id,
    site_short,
    region_short,
    Gender_c,
    first_generation_fy_20_c,
    indicator_low_income_c,
    Ethnic_background_c,
    student_count,
    college_aspiration_count,
    app_count,
    accepted_app_sum,
    accepted_student_sum,
    applied_sum