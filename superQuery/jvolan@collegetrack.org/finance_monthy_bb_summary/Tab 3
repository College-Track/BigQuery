WITH student_list AS
(
    SELECT
    -- Select fields from templates
    Contact_Id,
    Full_Name_c,
    site_text_c,
    current_cc_advisor_2_c,
    high_school_graduating_class_c,
    
    FROM
    `data-warehouse-289815.salesforce_clean.contact_template`
    WHERE College_Track_Status_c IN ('11A', '12A','15A', '16A')
    ),
    
student_list_bb_balance AS
(
    SELECT
    -- Select fields from templates
    id AS bb_app_id,
    student_c,
    finance_bb_balance_total_c,
    
    FROM
    `data-warehouse-289815.salesforce_clean.scholarship_application_clean`
    LEFT JOIN student_list ON student_list.Contact_Id = student_c
    WHERE record_type_id = "01246000000ZNi1AAG"
    AND finance_bb_balance_total_c > 0
    ),

bb_disbursements_fy AS
(
    SELECT
    -- Select fields from templates
    student_c AS bb_disburse_student_id,
    SUM (amount_c) as bb_disbursement_total,
    
    FROM
    `data-warehouse-289815.salesforce_clean.scholarship_transaction_clean`
    WHERE
    record_type_id = "01246000000ZNhsAAG"
    AND finance_reporting_date_c >= '2020-07-01'
    AND transaction_status_c = "Approved"
    GROUP BY student_c
    ),
    
bb_earnings_and_disbursements_fy AS
(
SELECT
    -- Select fields from templates
    student_c,
    SUM (amount_c) as bb_earnings_total,
    
    FROM
    `data-warehouse-289815.salesforce_clean.scholarship_transaction_clean`
    LEFT JOIN bb_disbursements_fy ON bb_disbursements_fy.bb_disburse_student_id = student_c
    WHERE
    record_type_id = "01246000000ZNhtAAG"
    AND created_date >= '2020-07-01'
    AND amount_c > 0
    GROUP BY student_c
    )
    
SELECT
    *,
    FROM
    student_list_bb_balance
    LEFT JOIN bb_earnings_and_disbursements_fy ON bb_earnings_and_disbursements_fy.student_c = student_list_bb_balance.student_c