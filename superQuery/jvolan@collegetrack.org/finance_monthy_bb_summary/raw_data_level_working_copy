--

WITH bb_d_e_fy AS
(
    SELECT
    student_c, 
    amount_c, 
    transaction_status_c,
    id AS bb_id,
    FORMAT_DATE("%x", finance_reporting_date_c)AS finance_reporting_date, 
    CASE
        WHEN record_type_id = "01246000000ZNhsAAG"then "BB Disbursement"
        WHEN record_type_id = "01246000000ZNhtAAG"then "BB Earnings"
        END AS BB_Record_Type,
    FORMAT_DATE("%m", CURRENT_DATE()) AS report_month,
    FORMAT_DATE("%x", CURRENT_DATE()) AS report_date,    
    
    FROM
    `data-warehouse-289815.salesforce_clean.scholarship_transaction_clean`
    WHERE
    finance_reporting_date_c > '2020-07-01'AND
    record_type_id = "01246000000ZNhsAAG" OR
    record_type_id = "01246000000ZNhtAAG"
),

bb_balance AS
(
    SELECT
    student_c,
    MAX(finance_bb_balance_total_c) AS Finance_BB_Balance,
    
    FROM
    `data-warehouse-289815.salesforce_clean.scholarship_application_clean`
    WHERE record_type_id = "01246000000ZNi1AAG"
    AND finance_bb_balance_total_c > 0
    GROUP BY student_c
 ),  
    
student_bb_balance_list AS
(
    SELECT
    Contact_Id,
    Full_Name_c,
    site_abrev AS Site,
    current_cc_advisor_2_c AS Current_CCA,
    high_school_graduating_class_c AS HS_Class,
    College_Track_Status_Name AS CT_Status,
    bb_balance.Finance_BB_Balance,
    FROM
    `data-warehouse-289815.salesforce_clean.contact_template`
    LEFT JOIN bb_balance ON bb_balance.student_c = Contact_Id
    WHERE College_Track_Status_c IN ('11A', '12A','15A', '16A')
),

bb_raw AS
(
    SELECT
    student_bb_balance_list.*,
    bb_d_e_fy.amount_c,
    bb_d_e_fy.transaction_status_c, 
    bb_d_e_fy.finance_reporting_date, 
    bb_d_e_fy.BB_Record_Type,
    bb_d_e_fy.report_month, 
    bb_d_e_fy.report_date, 
    FROM
    student_bb_balance_list
    LEFT JOIN bb_d_e_fy ON bb_d_e_fy.student_c = student_bb_balance_list.Contact_Id
)

    SELECT
    *
    FROM
    bb_raw
    
     
     
     
     
     